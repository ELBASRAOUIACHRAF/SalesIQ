<section class="pf-card" role="group" aria-label="Customer purchase frequency">
  <header class="pf-header">
    <div>
      <div class="eyebrow">Customer Insights</div>
      <h3 class="title"><mat-icon class="title-icon">shopping_bag</mat-icon> Purchase Frequency</h3>
      <p class="muted">Total sales and average monthly purchases per customer.</p>
    </div>
    <div class="header-actions">
      <button class="refresh-btn" (click)="loadPurchaseFrequency()" [disabled]="isLoading">
        <ng-container *ngIf="!isLoading">
          <mat-icon>refresh</mat-icon> <span>Refresh</span>
        </ng-container>
        <ng-container *ngIf="isLoading">
          <mat-icon class="spin">hourglass_empty</mat-icon> <span>Loading...</span>
        </ng-container>
      </button>
    </div>
  </header>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="error-banner">
    <mat-icon class="inline-icon">error_outline</mat-icon> {{ errorMessage }}
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <span>Loading customer data...</span>
  </div>

  <!-- Content (only show when not loading) -->
  <ng-container *ngIf="!isLoading">
    <div class="filters">
      <mat-icon class="search-icon">search</mat-icon>
      <input type="search" placeholder="Filter by username" (input)="setFilter($any($event.target).value)" />
      <select (change)="setSort($any($event.target).value)">
        <option value="avg">Sort by Avg / Month</option>
        <option value="total">Sort by Total Sales</option>
        <option value="name">Sort by Name</option>
      </select>
    </div>

    <div class="summary">
      <div class="chip">
        <mat-icon class="chip-icon">groups</mat-icon>
        <div class="chip-label">Customers</div>
        <div class="chip-value">{{ summary().total }}</div>
      </div>
      <div class="chip">
        <mat-icon class="chip-icon up">trending_up</mat-icon>
        <div class="chip-label">High frequency</div>
        <div class="chip-value">{{ summary().high }}</div>
      </div>
      <div class="chip">
        <mat-icon class="chip-icon up">trending_down</mat-icon>
        <div class="chip-label">Low frequency</div>
        <div class="chip-value">{{ summary().low }}</div>
      </div>
      <div class="chip" *ngIf="summary().top">
        <mat-icon class="chip-icon top">emoji_events</mat-icon>
        <div class="chip-label">Top performer</div>
        <div class="chip-value">{{ summary().top?.username }}</div>
        <div class="chip-sub">{{ summary().top?.totalSales | number:'1.0-0' }} total</div>
      </div>
    </div>

    <div class="list" *ngIf="filteredSorted().length; else empty">
      <div class="row head">
        <span>User</span>
        <span class="right">Total Sales</span>
        <span class="right">Avg / Month</span>
        <span class="right">Level</span>
      </div>
      <div class="row" *ngFor="let item of filteredSorted()">
        <div class="user">
          <div class="avatar">{{ item.username.charAt(0).toUpperCase() }}</div>
          <div>
            <div class="name">{{ item.username }}</div>
            <div class="sub">ID: {{ item.userId }}</div>
          </div>
        </div>
        <div class="right">{{ item.totalSales | number:'1.0-0' }}</div>
        <div class="right bar-wrap">
          <div class="bar" [style.width]="barWidth(item.averageSalesPerMonth)"></div>
          <span class="bar-label">{{ item.averageSalesPerMonth | number:'1.1-1' }}</span>
        </div>
        <div class="right">
          <span [class]="badgeClass(item.averageSalesPerMonth)" class="status-badge">
            <mat-icon class="tiny-icon">
              {{ item.averageSalesPerMonth > highFreqThreshold ? 'arrow_upward' : item.averageSalesPerMonth <= lowFreqThreshold ? 'arrow_downward' : 'remove' }}
            </mat-icon>
            {{ item.averageSalesPerMonth > highFreqThreshold ? 'High' : item.averageSalesPerMonth <= lowFreqThreshold ? 'Low' : 'Medium' }}
          </span>
        </div>
      </div>
    </div>

    <ng-template #empty>
      <mat-icon class="empty-icon">person_off</mat-icon>
      <div class="empty">No customer data found. Make sure there are sales in the database.</div>
    </ng-template>
  </ng-container>

  <!-- API Info -->
  <details class="api-info">
    <summary><mat-icon class="inline-icon">integration_instructions</mat-icon> API Details</summary>
    <div class="api-content">
      <code>GET /api/v1/analytics/purchase-frequency</code>
      <p>Returns purchase frequency analysis for all customers.</p>
    </div>
  </details>
</section>
