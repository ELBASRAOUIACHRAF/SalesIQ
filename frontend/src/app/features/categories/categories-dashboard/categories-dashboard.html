<div class="dashboard-layout">
  <div class="dashboard-content">
    <!-- Header -->
    <div class="dashboard-header">
      <app-top-bar
        [title]="'Categories Analytics'"
        [tabs]="['Overview']"
        [activeTab]="'Overview'"
        [dateText]="'Category Performance'"
      ></app-top-bar>
      
      <!-- Import/Export Actions -->
      <div class="action-bar">
        <div class="action-group">
          <span class="group-label">Categories:</span>
          <button class="action-btn import-btn" (click)="triggerImport()">
            <span class="icon"><mat-icon class="icon">file_upload</mat-icon></span> Import
          </button>
          <button class="action-btn export-btn" (click)="onExportCategories()">
            <span class="icon"><mat-icon class="icon">file_download</mat-icon></span> Export
          </button>
        </div>
        <input 
          #fileInput 
          type="file" 
          accept=".csv" 
          style="display: none;" 
          (change)="onFileSelected($event)"
        />
      </div>
      
      <!-- Import Status Message -->
      <div *ngIf="importMessage" class="import-message" [class.success]="importSuccess" [class.error]="!importSuccess">
        <mat-icon class="msg-icon">{{ importSuccess ? 'check_circle' : 'error' }}</mat-icon>
        {{ importMessage }}
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading categories...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="error-state">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <p class="error-message">{{ error }}</p>
      <button class="retry-btn" (click)="loadData()">
        <mat-icon>refresh</mat-icon> Retry
      </button>
    </div>

    <!-- Dashboard Content -->
    <ng-container *ngIf="!loading && !error">
      <!-- KPI Cards -->
      <div class="kpi-cards">
        <app-kpi-card
          *ngFor="let k of kpis"
          [title]="k.title"
          [value]="k.value"
          [subtitle]="k.subtitle"
          [change]="k.change"
          [sparkline]="k.sparkline"
          [accentColor]="k.accentColor"
        ></app-kpi-card>
      </div>

      <!-- Category Performance Chart -->
      <section class="analytics-section">
        <app-category-performance></app-category-performance>
      </section>

      <!-- Categories Section -->
      <section class="categories-section">
        <!-- Section Header with Controls -->
        <div class="section-header">
          <h2 class="section-title">
            <mat-icon class="section-icon">category</mat-icon>
            Categories ({{ filteredCategories.length }})
          </h2>
          
          <div class="controls">
            <!-- Search -->
            <div class="search-box">
              <mat-icon class="search-icon">search</mat-icon>
              <input 
                type="text" 
                placeholder="Search categories..." 
                [(ngModel)]="searchTerm"
              />
            </div>

            <!-- Filter Status -->
            <div class="filter-group">
              <button 
                class="filter-btn" 
                [class.active]="filterStatus === 'all'"
                (click)="filterStatus = 'all'"
              >All</button>
              <button 
                class="filter-btn" 
                [class.active]="filterStatus === 'active'"
                (click)="filterStatus = 'active'"
              >Active</button>
              <button 
                class="filter-btn" 
                [class.active]="filterStatus === 'inactive'"
                (click)="filterStatus = 'inactive'"
              >Inactive</button>
            </div>
          </div>
        </div>

        <!-- Categories Table -->
        <div class="categories-table-container">
          <table class="categories-table">
            <thead>
              <tr>
                <th (click)="setSortBy('name')" class="sortable">
                  Category Name
                  <mat-icon class="sort-icon" *ngIf="sortBy === 'name'">
                    {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </th>
                <th (click)="setSortBy('products')" class="sortable">
                  Products
                  <mat-icon class="sort-icon" *ngIf="sortBy === 'products'">
                    {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </th>
                <th (click)="setSortBy('revenue')" class="sortable">
                  Revenue
                  <mat-icon class="sort-icon" *ngIf="sortBy === 'revenue'">
                    {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </th>
                <th>Performance</th>
                <th (click)="setSortBy('status')" class="sortable">
                  Status
                  <mat-icon class="sort-icon" *ngIf="sortBy === 'status'">
                    {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let category of filteredCategories" class="category-row">
                <td class="category-name-cell">
                  <div class="category-info">
                    <div class="category-icon" [style.background]="category.isActive ? '#6366f1' : '#9ca3af'">
                      {{ category.name.charAt(0).toUpperCase() }}
                    </div>
                    <div class="category-details">
                      <span class="category-name">{{ category.name }}</span>
                      <span class="category-desc">{{ category.description || 'No description' }}</span>
                    </div>
                  </div>
                </td>
                <td class="products-cell">
                  <span class="product-count">{{ category.productCount || 0 }}</span>
                  <span class="product-label">products</span>
                </td>
                <td class="revenue-cell">
                  <span class="revenue-amount">{{ formatCurrency(category.revenue || 0) }}</span>
                  <span class="sales-count">{{ category.salesCount || 0 }} sales</span>
                </td>
                <td class="performance-cell">
                  <div class="performance-bar-container">
                    <div class="performance-bar" [style.width.%]="getRevenuePercentage(category.revenue || 0)"></div>
                  </div>
                  <span class="performance-label">{{ getRevenuePercentage(category.revenue || 0) | number:'1.0-0' }}%</span>
                </td>
                <td class="status-cell">
                  <span 
                    class="status-badge" 
                    [class.active]="category.isActive"
                    [class.inactive]="!category.isActive"
                  >
                  <mat-icon class="tiny-icon">{{ category.isActive ? 'check_circle' : 'cancel' }}</mat-icon>
                    {{ category.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Empty State -->
          <div *ngIf="filteredCategories.length === 0" class="empty-state">
            <mat-icon class="empty-icon">folder_off</mat-icon>
            <h3>No categories found</h3>
            <p *ngIf="searchTerm">No categories match "{{ searchTerm }}"</p>
            <p *ngIf="!searchTerm">No categories available</p>
          </div>
        </div>
      </section>
    </ng-container>
  </div>
</div>