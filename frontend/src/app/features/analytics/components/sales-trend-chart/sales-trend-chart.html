<!--
  SALES TREND CHART TEMPLATE
  ==========================
  
  HOW THE BUTTON WORKS:
  1. User fills in the inputs (startDate, endDate, granularity)
  2. [(ngModel)] binds input values to component properties
  3. User clicks the "Analyze Sales Trend" button
  4. (click)="onAnalyzeClick()" triggers the method in the component
  5. onAnalyzeClick() calls the service which makes HTTP request
  6. Response updates salesTrendData, Angular re-renders the template
-->

<div class="sales-trend-container">
  
  <!-- ========== HEADER ========== -->
  <div class="card-header">
    <h3>ğŸ“ˆ Sales Trend Analysis</h3>
    <p class="subtitle">Analyze your sales data over time with different granularities</p>
  </div>

  <!-- ========== INPUT FORM ========== -->
  <div class="form-section">
    
    <!-- Row 1: Date Inputs -->
    <div class="input-row">
      <div class="input-group">
        <label for="startDate">ğŸ“… Start Date</label>
        <input 
          type="date" 
          id="startDate" 
          [(ngModel)]="startDate"
          [max]="endDate"
        />
        <!-- 
          [(ngModel)]="startDate" 
          This is TWO-WAY BINDING:
          - When user types, it updates this.startDate in the component
          - When this.startDate changes in code, input value updates
        -->
      </div>
      
      <div class="input-group">
        <label for="endDate">ğŸ“… End Date</label>
        <input 
          type="date" 
          id="endDate" 
          [(ngModel)]="endDate"
          [min]="startDate"
        />
      </div>
      
      <div class="input-group">
        <label for="granularity">ğŸ“Š Time Granularity</label>
        <select 
          id="granularity" 
          [(ngModel)]="selectedGranularity"
        >
          <!--
            *ngFor loops through granularityOptions array
            Each option's value is set to the option string
          -->
          <option *ngFor="let option of granularityOptions" [value]="option">
            {{ option }}
          </option>
        </select>
      </div>
    </div>

    <!-- Row 2: THE BUTTON -->
    <div class="button-row">
      <!--
        THE ANALYZE BUTTON
        ==================
        (click)="onAnalyzeClick()" 
        
        When clicked:
        1. Angular calls onAnalyzeClick() method in the component
        2. Method validates inputs
        3. Calls analyticsService.getSalesTrend(startDate, endDate, granularity)
        4. Service makes HTTP GET request to backend
        5. Backend returns data
        6. Component receives data and updates salesTrendData
        7. Angular detects change and re-renders this template
        
        [disabled]="isLoading"
        - Disables button while API call is in progress
        - Prevents multiple simultaneous requests
      -->
      <button 
        class="analyze-button"
        (click)="onAnalyzeClick()"
        [disabled]="isLoading"
      >
        <span *ngIf="!isLoading">ğŸ” Analyze Sales Trend</span>
        <span *ngIf="isLoading">â³ Loading...</span>
      </button>
      
      <span class="hint-text">
        Click the button to fetch data from the backend API
      </span>
    </div>
  </div>

  <!-- ========== ERROR MESSAGE ========== -->
  <div *ngIf="errorMessage" class="error-state">
    <p>âš ï¸ {{ errorMessage }}</p>
    <button class="retry-button" (click)="onAnalyzeClick()">ğŸ”„ Retry</button>
  </div>

  <!-- ========== LOADING SPINNER ========== -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Fetching data from backend...</p>
    <code>GET /api/v1/analytics/sales-trend</code>
  </div>

  <!-- ========== INITIAL STATE (before any search) ========== -->
  <div *ngIf="!hasSearched && !isLoading" class="initial-state">
    <div class="empty-icon">ğŸ“Š</div>
    <p>Select a date range and granularity, then click <strong>Analyze</strong> to see your sales trends.</p>
  </div>

  <!-- ========== RESULTS SECTION ========== -->
  <div *ngIf="!isLoading && !errorMessage && salesTrendData && hasSearched" class="data-section">
    
    <!-- KPI Summary Cards -->
    <div class="kpi-row">
      <div class="kpi-item">
        <span class="kpi-label">Total Revenue</span>
        <span class="kpi-value">${{ totalRevenue | number:'1.2-2' }}</span>
      </div>
      <div class="kpi-item">
        <span class="kpi-label">Total Sales</span>
        <span class="kpi-value">{{ totalSalesCount | number }}</span>
      </div>
      <div class="kpi-item">
        <span class="kpi-label">Data Points</span>
        <span class="kpi-value">{{ salesTrendData.points.length }}</span>
      </div>
      <div class="kpi-item">
        <span class="kpi-label">Granularity</span>
        <span class="kpi-value granularity-badge">{{ salesTrendData.timeGranularity }}</span>
      </div>
    </div>

    <!-- Bar Chart Visualization -->
    <div class="chart-container" *ngIf="salesTrendData.points.length > 0">
      <h4>Revenue Over Time</h4>
      <div class="bar-chart">
        <div 
          *ngFor="let point of salesTrendData.points; let i = index"
          class="bar-wrapper"
        >
          <div 
            class="bar"
            [style.height.%]="totalRevenue > 0 ? (point.revenue / totalRevenue) * 100 * salesTrendData.points.length : 0"
            [title]="'Revenue: $' + point.revenue"
          ></div>
          <span class="bar-label">{{ chartLabels[i] }}</span>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-container" *ngIf="salesTrendData.points.length > 0">
      <h4>Detailed Data</h4>
      <table>
        <thead>
          <tr>
            <th>Period</th>
            <th>Revenue</th>
            <th>Sales Count</th>
            <th>Quantity Sold</th>
            <th>Avg Sale Value</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let point of salesTrendData.points">
            <td>{{ point.periodStart | date:'mediumDate' }}</td>
            <td class="number-cell">${{ point.revenue | number:'1.2-2' }}</td>
            <td class="number-cell">{{ point.salesCount | number }}</td>
            <td class="number-cell">{{ point.quantitySold | number }}</td>
            <td class="number-cell">${{ point.averageSaleValue | number:'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty Results -->
    <div *ngIf="salesTrendData.points.length === 0" class="empty-results">
      <p>ğŸ“­ No sales data found for the selected period.</p>
      <p>Try selecting a different date range.</p>
    </div>
  </div>

  <!-- ========== API INFO (for learning) ========== -->
  <div class="api-info">
    <details>
      <summary>ğŸ”§ API Details (click to expand)</summary>
      <div class="api-details">
        <p><strong>Endpoint:</strong> <code>GET /api/v1/analytics/sales-trend</code></p>
        <p><strong>Parameters:</strong></p>
        <ul>
          <li><code>startDate</code>: {{ startDate }} â†’ {{ startDate ? (startDate | date:'medium') : 'not set' }}</li>
          <li><code>endDate</code>: {{ endDate }} â†’ {{ endDate ? (endDate | date:'medium') : 'not set' }}</li>
          <li><code>granularity</code>: {{ selectedGranularity }}</li>
        </ul>
        <p><strong>Full URL:</strong></p>
        <code class="full-url">http://localhost:8080/api/v1/analytics/sales-trend?startDate={{startDate}}&endDate={{endDate}}&granularity={{selectedGranularity}}</code>
      </div>
    </details>
  </div>
</div>
