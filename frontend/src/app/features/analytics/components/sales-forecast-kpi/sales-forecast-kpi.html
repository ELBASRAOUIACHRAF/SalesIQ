<section class="forecast-card" role="group" aria-label="Sales forecast summary">
  <header class="card-header">
    <div class="title-block">
      <p class="eyebrow"><mat-icon class="tiny-icon">show_chart</mat-icon> {{ title }}</p>
      <div class="horizon">{{ horizonLabel }}</div>
    </div>
    <div class="controls">
      <label class="horizon-input">
        <span><mat-icon class="tiny-icon">calendar_today</mat-icon> Days</span>
        <input type="number" min="1" max="365" [ngModel]="horizonDays" (ngModelChange)="updateHorizon($event)" />
      </label>
      <button type="button" class="action" (click)="triggerRequest()" [disabled]="isLoading">
        <ng-container *ngIf="!isLoading">
          <mat-icon>auto_awesome</mat-icon> <span>Generate</span>
        </ng-container>
        <ng-container *ngIf="isLoading">
          <mat-icon class="spin">hourglass_empty</mat-icon> <span>Loading...</span>
        </ng-container>
      </button>
    </div>
  </header>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="error-banner">
    <mat-icon class="inline-icon">error_outline</mat-icon> {{ errorMessage }}
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="spinner-small"></div>
    <span>Generating forecast...</span>
  </div>

  <div class="kpi-row">
    <div class="value">
      <span class="currency">{{ currencySymbol }}</span>
      <span class="number">{{ total | number:'1.0-0' }}</span>
    </div>
    <div class="trend" [class.up]="trend === 'up'" [class.down]="trend === 'down'" [class.flat]="trend === 'flat'">
      <mat-icon class="trend-icon">{{ trendIcon }}</mat-icon>
      <span class="trend-label">{{ changeLabel }}</span>
    </div>
  </div>

  <div class="sparkline" aria-hidden="true">
    <svg [attr.viewBox]="'0 0 ' + viewBoxWidth + ' ' + viewBoxHeight" preserveAspectRatio="none">
      <defs>
        <linearGradient id="forecastGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#6366f1" stop-opacity="0.22" />
          <stop offset="100%" stop-color="#6366f1" stop-opacity="0.05" />
        </linearGradient>
      </defs>

      <path *ngIf="historicalPath" class="line historical" [attr.d]="historicalPath"></path>
      <path *ngIf="forecastPath" class="line forecast" [attr.d]="forecastPath"></path>

      <line *ngIf="forecast.length" class="forecast-divider" [attr.x1]="forecastStartX" [attr.x2]="forecastStartX" y1="0" [attr.y2]="viewBoxHeight"></line>

      <circle *ngIf="histPoint" class="dot" [attr.cx]="histPoint.x" [attr.cy]="histPoint.y" r="2.5"></circle>
      <circle *ngIf="lastPoint" class="dot forecast" [attr.cx]="lastPoint.x" [attr.cy]="lastPoint.y" r="2.8"></circle>
    </svg>
  </div>

  <div class="meta-row">
    <div class="meta">{{ model }} · updated {{ lastUpdated }} · {{ forecastHorizonLabel }}</div>
    <div class="insight"><mat-icon class="inline-icon">lightbulb</mat-icon> {{ insight }}</div>
  </div>

  <div class="forecast-list" *ngIf="forecastEntries.length">
    <div class="forecast-row" *ngFor="let f of forecastEntries">
      <span class="day">
        <mat-icon class="tiny-icon faded">today</mat-icon>
        <ng-container *ngIf="f.date">{{ f.date }}</ng-container>
        <ng-container *ngIf="!f.date">Day {{ f.day }}</ng-container>
      </span>
      <span class="value">{{ currencySymbol }}{{ f.value | number:'1.0-0' }}</span>
    </div>
  </div>

  <!-- API Info -->
  <details class="api-info">
    <summary><mat-icon class="inline-icon">integration_instructions</mat-icon> API Details</summary>
    <div class="api-content">
      <code>GET /api/v1/analytics/forecastSales?daysAhead={{ horizonDays }}</code>
    </div>
  </details>
</section>
