<!-- Loading State -->
<div *ngIf="isLoading" class="loading-grid">
  <div class="skeleton-card" *ngFor="let i of [1,2,3,4,5,6,7,8]">
    <div class="skeleton-image"></div>
    <div class="skeleton-content">
      <div class="skeleton-line title"></div>
      <div class="skeleton-line short"></div>
      <div class="skeleton-line medium"></div>
      <div class="skeleton-line button"></div>
    </div>
  </div>
</div>

<!-- No Products Message -->
<div *ngIf="!isLoading && filteredProducts.length === 0" class="no-products-message">
  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" class="empty-icon">
    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <h3>No products found</h3>
  <p>Try adjusting your filters or search criteria</p>
</div>

<!-- Products Grid -->
<div class="product-grid" *ngIf="!isLoading && filteredProducts.length > 0">
  <article class="product-card" *ngFor="let product of paginatedProducts; trackBy: trackByProductId">
    <!-- Wishlist Button -->
    <button (click)="onAddToWishlist(product)" class="wishlist-button" aria-label="Add to wishlist">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <!-- Product Image -->
    <div class="product-image-container" [routerLink]="['/product', product.id]">
      <div *ngIf="product.discount > 0" class="discount-badge">
        -{{ product.discount }}%
      </div>
      <img [src]="product.imageUrl" 
           [alt]="product.name" 
           class="product-image"
           loading="lazy"
           (error)="$event.target.src='assets/placeholder-product.png'">
    </div>

    <!-- Product Details -->
    <div class="product-details">
      <h2 class="product-name" [routerLink]="['/product', product.id]">
        {{ product.name }}
      </h2>

      <!-- Rating -->
      <div class="product-rating" [title]="(product.rating | number:'1.1-1') + ' out of 5 stars'">
        <div class="stars">
          <span *ngFor="let i of [1,2,3,4,5].slice(0, fullStars(product.rating))" class="star filled">★</span>
          <span *ngIf="hasHalfStar(product.rating)" class="star half">★</span>
          <span *ngFor="let i of [1,2,3,4,5].slice(0, emptyStars(product.rating))" class="star empty">★</span>
        </div>
        <span class="review-count">{{ product.reviewsCount }}</span>
      </div>

      <!-- Price -->
      <div class="product-price-section">
        <span class="current-price" [class.discounted]="product.discount > 0">
          ${{ product.price | number:'1.2-2' }}
        </span>
        <span *ngIf="product.discount > 0" class="list-price">
          ${{ product.price / (1 - product.discount / 100) | number:'1.2-2' }}
        </span>
      </div>

      <!-- Stock Status -->
      <p class="stock-status" 
         [class.in-stock]="product.stock > 10"
         [class.low-stock]="product.stock <= 10 && product.stock > 0"
         [class.out-of-stock]="product.stock === 0">
        <span *ngIf="product.stock > 10">In Stock</span>
        <span *ngIf="product.stock <= 10 && product.stock > 0">Only {{ product.stock }} left!</span>
        <span *ngIf="product.stock === 0">Out of Stock</span>
      </p>

      <!-- Add to Cart Button -->
      <button 
        class="add-to-cart-button" 
        [class.adding]="isAddingToCart(product.id)"
        [class.added]="wasAddedToCart(product.id)"
        [disabled]="product.stock === 0 || isAddingToCart(product.id)"
        (click)="onAddToCart(product)">
        <ng-container *ngIf="!isAddingToCart(product.id) && !wasAddedToCart(product.id)">
          <svg *ngIf="product.stock > 0" width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          {{ product.stock === 0 ? 'Out of Stock' : 'Add to Cart' }}
        </ng-container>
        <ng-container *ngIf="isAddingToCart(product.id)">
          <div class="button-spinner"></div>
          Adding...
        </ng-container>
        <ng-container *ngIf="wasAddedToCart(product.id)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Added!
        </ng-container>
      </button>
    </div>
  </article>
</div>

<!-- Pagination -->
<nav class="pagination-container" *ngIf="totalPages > 1 && filteredProducts.length > 0" aria-label="Product pagination">
  <button
    class="page-button nav"
    (click)="goToPage(1)"
    [disabled]="currentPage === 1"
    aria-label="First page">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M11 17l-5-5 5-5M18 17l-5-5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  
  <button
    class="page-button nav"
    (click)="goToPage(currentPage - 1)"
    [disabled]="currentPage === 1"
    aria-label="Previous page">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <div class="page-numbers">
    <button 
      *ngFor="let page of visiblePages"
      class="page-button number"
      [class.active]="page === currentPage"
      (click)="goToPage(page)">
      {{ page }}
    </button>
  </div>

  <button
    class="page-button nav"
    (click)="goToPage(currentPage + 1)"
    [disabled]="currentPage === totalPages"
    aria-label="Next page">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  
  <button
    class="page-button nav"
    (click)="goToPage(totalPages)"
    [disabled]="currentPage === totalPages"
    aria-label="Last page">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M13 17l5-5-5-5M6 17l5-5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
</nav>